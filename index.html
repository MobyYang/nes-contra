<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>é­‚æ–—ç½—</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 200px; /* ç»™æ‰‹æŸ„ç•™ç©ºé—´ */
            background: #1a1a2e;
        }
        
        h1 { color: #e94560; font-size: 20px; margin: 10px 0; font-family: sans-serif; }
        
        .game-wrapper {
            background: #16213e;
            border-radius: 12px;
            padding: 10px;
            width: 100%;
            max-width: 100vw;
        }
        
        #game-canvas {
            display: block;
            background: #000;
            border-radius: 8px;
            image-rendering: pixelated;
            width: 100%;
            height: auto;
            aspect-ratio: 256 / 240;
        }
        
        .top-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .top-controls button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        #status {
            margin-top: 8px;
            padding: 8px 16px;
            background: rgba(0,255,0,0.15);
            border-radius: 8px;
            color: #4ade80;
            font-size: 13px;
            font-family: sans-serif;
        }
        
        /* ç«–å±æ‰‹æŸ„ */
        .gamepad {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px 25px 20px;
            padding-bottom: 140px;
            background: linear-gradient(transparent, rgba(0,0,0,0.95));
            height: 290px;
        }
        
        .dpad-container {
            position: relative;
            width: 130px;
            height: 130px;
        }
        
        .dpad-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background: rgba(50,50,50,0.5);
            border-radius: 50%;
        }
        
        .dpad-btn {
            position: absolute;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(233,69,96,0.8);
            color: #e94560;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .dpad-btn:active, .dpad-btn.pressed { background: #e94560; color: #fff; }
        
        .dpad-up { top: 0; left: 50%; transform: translateX(-50%); width: 42px; height: 42px; border-radius: 8px; }
        .dpad-down { bottom: 0; left: 50%; transform: translateX(-50%); width: 42px; height: 42px; border-radius: 8px; }
        .dpad-left { left: 0; top: 50%; transform: translateY(-50%); width: 42px; height: 42px; border-radius: 8px; }
        .dpad-right { right: 0; top: 50%; transform: translateY(-50%); width: 42px; height: 42px; border-radius: 8px; }
        
        .dpad-ul { top: 5px; left: 5px; width: 28px; height: 28px; border-radius: 5px; font-size: 11px; opacity: 0.6; }
        .dpad-ur { top: 5px; right: 5px; width: 28px; height: 28px; border-radius: 5px; font-size: 11px; opacity: 0.6; }
        .dpad-dl { bottom: 5px; left: 5px; width: 28px; height: 28px; border-radius: 5px; font-size: 11px; opacity: 0.6; }
        .dpad-dr { bottom: 5px; right: 5px; width: 28px; height: 28px; border-radius: 5px; font-size: 11px; opacity: 0.6; }
        
        .right-controls { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-right: -10px; }
        
        .action-row { display: flex; gap: 10px; align-items: center; }
        
        .action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(233,69,96,0.3);
            border: 3px solid #e94560;
            color: #e94560;
            font-size: 20px;
            font-weight: bold;
            font-family: sans-serif;
        }
        
        .action-btn:active, .action-btn.pressed { background: #e94560; color: #fff; }
        
        .btn-c { background: rgba(46,204,113,0.3); border-color: #2ecc71; color: #2ecc71; }
        .btn-c:active, .btn-c.pressed { background: #2ecc71; color: #fff; }
        .btn-b { }
        .btn-a { width: 68px; height: 68px; font-size: 24px; }
        
        .start-row { display: flex; gap: 15px; }
        
        .small-btn {
            background: rgba(100,100,100,0.4);
            border: 2px solid #888;
            color: #ccc;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 11px;
            font-family: sans-serif;
        }
        
        .small-btn:active, .small-btn.pressed { background: #e94560; color: #fff; border-color: #e94560; }
        
        /* ========== å…¨å±æ¨ªå±æ¨¡å¼ ========== */
        .fullscreen-mode {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: none;
            z-index: 9999;
        }
        
        .fullscreen-mode.active { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #000; 
        }
        
        /* æ¸¸æˆç”»å¸ƒ - å°½å¯èƒ½å¡«æ»¡ */
        #game-canvas-fs {
            height: 100%;
            width: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }
        
        /* å·¦ä¾§åå­—é”® */
        .fs-dpad {
            position: absolute;
            left: 20px;
            bottom: 15%;
            width: 150px;
            height: 150px;
            z-index: 10000;
        }
        
        .fs-dpad-inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .fs-dpad-inner .dpad-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: rgba(50,50,50,0.3);
            border-radius: 50%;
        }
        
        .fs-dpad-inner .dpad-btn {
            position: absolute;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(233,69,96,0.6);
            color: rgba(233,69,96,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .fs-dpad-inner .dpad-btn:active, .fs-dpad-inner .dpad-btn.pressed { background: rgba(233,69,96,0.8); color: #fff; }
        
        .fs-dpad-inner .dpad-up { top: 5px; left: 50%; transform: translateX(-50%); width: 42px; height: 42px; border-radius: 10px; font-size: 16px; }
        .fs-dpad-inner .dpad-down { bottom: 5px; left: 50%; transform: translateX(-50%); width: 42px; height: 42px; border-radius: 10px; font-size: 16px; }
        .fs-dpad-inner .dpad-left { left: 5px; top: 50%; transform: translateY(-50%); width: 42px; height: 42px; border-radius: 10px; font-size: 16px; }
        .fs-dpad-inner .dpad-right { right: 5px; top: 50%; transform: translateY(-50%); width: 42px; height: 42px; border-radius: 10px; font-size: 16px; }
        
        .fs-dpad-inner .dpad-ul { top: 10px; left: 10px; width: 28px; height: 28px; border-radius: 8px; font-size: 11px; opacity: 0.5; }
        .fs-dpad-inner .dpad-ur { top: 10px; right: 10px; width: 28px; height: 28px; border-radius: 8px; font-size: 11px; opacity: 0.5; }
        .fs-dpad-inner .dpad-dl { bottom: 10px; left: 10px; width: 28px; height: 28px; border-radius: 8px; font-size: 11px; opacity: 0.5; }
        .fs-dpad-inner .dpad-dr { bottom: 10px; right: 10px; width: 28px; height: 28px; border-radius: 8px; font-size: 11px; opacity: 0.5; }
        
        /* å³ä¾§æŒ‰é’®åŒº - A/B + SELECT/START */
        .fs-buttons {
            position: absolute;
            right: 30px;
            bottom: 10%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 10000;
        }
        
        .fs-buttons .action-row {
            display: flex;
            gap: 15px;
        }
        
        .fs-buttons .action-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: rgba(233,69,96,0.2);
            border: 3px solid rgba(233,69,96,0.7);
            color: rgba(233,69,96,0.9);
            font-size: 18px;
            font-weight: bold;
        }
        
        .fs-buttons .action-btn:active, .fs-buttons .action-btn.pressed { background: rgba(233,69,96,0.8); color: #fff; }
        
        .fs-buttons .btn-c { margin-top: 15px; background: rgba(46,204,113,0.2); border-color: rgba(46,204,113,0.7); color: rgba(46,204,113,0.9); }
        .fs-buttons .btn-c:active, .fs-buttons .btn-c.pressed { background: rgba(46,204,113,0.8); color: #fff; }
        .fs-buttons .btn-b { margin-top: 0; }
        .fs-buttons .btn-a { margin-top: -10px; width: 65px; height: 65px; font-size: 22px; }
        
        .fs-buttons .start-row {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .fs-buttons .small-btn {
            background: rgba(80,80,80,0.3);
            border: 2px solid rgba(136,136,136,0.5);
            color: rgba(200,200,200,0.8);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 10px;
        }
        
        .fs-buttons .small-btn:active, .fs-buttons .small-btn.pressed { background: rgba(233,69,96,0.8); color: #fff; border-color: #e94560; }
        
        /* ç«–å±æ—¶å¼ºåˆ¶æ—‹è½¬æ˜¾ç¤ºä¸ºæ¨ªå± - å¿…é¡»åœ¨ fs-dpad/fs-buttons åŸºç¡€æ ·å¼ä¹‹å */
        @media (orientation: portrait) {
            .fullscreen-mode.active {
                position: fixed;
                width: 100vh;
                height: 100vw;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(90deg);
            }
            
            /* æ—‹è½¬90åº¦ååæ ‡æ˜ å°„ï¼šåŸright+bottom â†’ æ—‹è½¬åå·¦ä¸‹ï¼ŒåŸright+top â†’ æ—‹è½¬åå³ä¸‹ */
            .fullscreen-mode.active .fs-dpad {
                left: auto !important;
                top: auto !important;
                right: 30px !important;
                bottom: 30px !important;
            }
            
            .fullscreen-mode.active .fs-buttons {
                left: auto !important;
                bottom: auto !important;
                right: 30px !important;
                top: 60px !important;
            }
        }
        
        /* é€€å‡ºæŒ‰é’® */
        .exit-fs {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.8);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-family: sans-serif;
            z-index: 10001;
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹å…ƒç´ å§‹ç»ˆå¯è§ */
        .fullscreen-mode.active #game-canvas-fs,
        .fullscreen-mode.active .fs-dpad,
        .fullscreen-mode.active .fs-buttons,
        .fullscreen-mode.active .exit-fs { opacity: 1; pointer-events: auto; }
        
        .keyboard-info {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 12px;
            color: #888;
            font-family: sans-serif;
            max-width: 350px;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .keyboard-info h3 { color: #e94560; margin-bottom: 8px; font-size: 13px; }
        
        /* æ¡Œé¢ç«¯æ˜¾ç¤ºé”®ç›˜æç¤ºï¼Œéšè—æ‰‹æŸ„ */
        @media (min-width: 600px) {
            .gamepad { display: none; }
            .keyboard-info { display: block; }
        }
        
        /* ç§»åŠ¨ç«¯ï¼šçŠ¶æ€æ æ›´ç´§å‡‘ */
        @media (max-width: 599px) {
            h1 { font-size: 16px; margin: 5px 0; }
            .top-controls button { padding: 8px 12px; font-size: 12px; }
            #status { font-size: 11px; padding: 6px 10px; }
            .game-wrapper { padding: 5px; }
        }
    </style>
</head>
<body>
    <div class="container" id="normalMode">
        <h1>ğŸ® é­‚æ–—ç½—</h1>
        <div class="game-wrapper">
            <canvas id="game-canvas" width="256" height="240"></canvas>
            <div class="top-controls">
                <button id="pauseBtn">â¸ï¸</button>
                <button id="resetBtn">ğŸ”„</button>
                <button id="fullscreenBtn">ğŸ“º å…¨å±</button>
                <button id="soundBtn">ğŸ”‡ éŸ³æ•ˆ</button>
            </div>
            <div id="status">â³ åŠ è½½ä¸­...</div>
        </div>
        
        <div class="keyboard-info">
            <h3>âŒ¨ï¸ æ–¹å‘é”® | Xè·³ | Zå°„ | Enterå¼€å§‹</h3>
        </div>
        
        <div class="gamepad">
            <div class="dpad-container">
                <div class="dpad-bg"></div>
                <button class="dpad-btn dpad-up" data-key="up">â†‘</button>
                <button class="dpad-btn dpad-down" data-key="down">â†“</button>
                <button class="dpad-btn dpad-left" data-key="left">â†</button>
                <button class="dpad-btn dpad-right" data-key="right">â†’</button>
                <button class="dpad-btn dpad-ul" data-keys="up,left">â†–</button>
                <button class="dpad-btn dpad-ur" data-keys="up,right">â†—</button>
                <button class="dpad-btn dpad-dl" data-keys="down,left">â†™</button>
                <button class="dpad-btn dpad-dr" data-keys="down,right">â†˜</button>
            </div>
            <div class="right-controls">
                <div class="action-row">
                    <button class="action-btn btn-c" data-key="turbo-b">C</button>
                    <button class="action-btn btn-b" data-key="b">B</button>
                    <button class="action-btn btn-a" data-key="a">A</button>
                </div>
                <div class="start-row">
                    <button class="small-btn" data-key="select">SEL</button>
                    <button class="small-btn" data-key="start">START</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±æ¨¡å¼ -->
    <div class="fullscreen-mode" id="fullscreenMode">
        <button class="exit-fs" id="exitFsBtn">âœ•</button>
        
        <canvas id="game-canvas-fs" width="512" height="480"></canvas>
        
        <div class="fs-dpad" id="fsDpad">
            <div class="fs-dpad-inner">
                <div class="dpad-bg"></div>
                <button class="dpad-btn dpad-up" data-key="up">â†‘</button>
                <button class="dpad-btn dpad-down" data-key="down">â†“</button>
                <button class="dpad-btn dpad-left" data-key="left">â†</button>
                <button class="dpad-btn dpad-right" data-key="right">â†’</button>
                <button class="dpad-btn dpad-ul" data-keys="up,left">â†–</button>
                <button class="dpad-btn dpad-ur" data-keys="up,right">â†—</button>
                <button class="dpad-btn dpad-dl" data-keys="down,left">â†™</button>
                <button class="dpad-btn dpad-dr" data-keys="down,right">â†˜</button>
            </div>
        </div>
        
        <div class="fs-buttons">
            <div class="action-row">
                <button class="action-btn btn-c" data-key="turbo-b">C</button>
                <button class="action-btn btn-b" data-key="b">B</button>
                <button class="action-btn btn-a" data-key="a">A</button>
            </div>
            <div class="start-row">
                <button class="small-btn" data-key="select">SEL</button>
                <button class="small-btn" data-key="start">START</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/jsnes@1.2.1/dist/jsnes.min.js"></script>
    <script>
        const canvas = document.getElementById('game-canvas');
        const canvasFs = document.getElementById('game-canvas-fs');
        const ctx = canvas.getContext('2d');
        const ctxFs = canvasFs.getContext('2d');
        const status = document.getElementById('status');
        const soundBtn = document.getElementById('soundBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const exitFsBtn = document.getElementById('exitFsBtn');
        
        let nes = null;
        let frameBuffer = null;
        let animationId = null;
        let isPaused = false;
        let isFullscreen = false;
        let soundEnabled = false;
        
        // ========== éŸ³é¢‘ç³»ç»Ÿ (iOS å…¼å®¹) ==========
        let audioCtx = null;
        let audioSamples = [];
        const SAMPLE_RATE = 44100;
        const BUFFER_SIZE = 2048;
        
        function unlockAudio() {
            if (audioCtx) {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        console.log('AudioContext resumed');
                    });
                }
                return;
            }
            
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext({ sampleRate: SAMPLE_RATE });
                
                // iOS éœ€è¦æ’­æ”¾ä¸€ä¸ªç©ºçš„ buffer æ¥è§£é”
                const buffer = audioCtx.createBuffer(1, 1, SAMPLE_RATE);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
                
                // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
                const scriptNode = audioCtx.createScriptProcessor(BUFFER_SIZE, 0, 2);
                scriptNode.onaudioprocess = function(e) {
                    if (!soundEnabled) return;
                    
                    const left = e.outputBuffer.getChannelData(0);
                    const right = e.outputBuffer.getChannelData(1);
                    
                    for (let i = 0; i < BUFFER_SIZE; i++) {
                        if (audioSamples.length >= 2) {
                            left[i] = audioSamples.shift();
                            right[i] = audioSamples.shift();
                        } else {
                            left[i] = 0;
                            right[i] = 0;
                        }
                    }
                };
                scriptNode.connect(audioCtx.destination);
                
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                
                console.log('Audio initialized, state:', audioCtx.state);
            } catch(e) {
                console.error('Audio init error:', e);
            }
        }
        
        function toggleSound() {
            // å…ˆç¡®ä¿éŸ³é¢‘å·²è§£é”
            unlockAudio();
            
            soundEnabled = !soundEnabled;
            audioSamples = []; // æ¸…ç©ºç¼“å†²
            
            if (soundEnabled) {
                soundBtn.textContent = 'ğŸ”Š éŸ³æ•ˆ';
                showStatus('ğŸ”Š éŸ³æ•ˆå·²å¼€å¯');
            } else {
                soundBtn.textContent = 'ğŸ”‡ éŸ³æ•ˆ';
                showStatus('ğŸ”‡ éŸ³æ•ˆå·²å…³é—­');
            }
        }
        
        // åœ¨ä»»ä½•è§¦æ‘¸æ—¶è§£é”éŸ³é¢‘
        document.addEventListener('touchstart', unlockAudio, { once: true });
        document.addEventListener('touchend', unlockAudio, { once: true });
        document.addEventListener('click', unlockAudio, { once: true });
        
        // ä»åå°æ¢å¤æ—¶é‡æ–°æ¿€æ´»éŸ³é¢‘
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && soundEnabled) {
                resumeAudio();
            }
        });
        
        // æ¢å¤éŸ³é¢‘çš„å‡½æ•°
        function resumeAudio() {
            if (!audioCtx) {
                unlockAudio();
                return;
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log('Audio resumed');
                    showStatus('ğŸ”Š éŸ³æ•ˆå·²æ¢å¤');
                }).catch(e => console.error('Resume failed:', e));
            }
        }
        
        // æ¯æ¬¡è§¦æ‘¸éƒ½å°è¯•æ¢å¤éŸ³é¢‘
        document.addEventListener('touchstart', () => {
            if (soundEnabled) resumeAudio();
        }, { passive: true });
        
        document.addEventListener('touchend', () => {
            if (soundEnabled) resumeAudio();
        }, { passive: true });
        
        // ========== NES æ¨¡æ‹Ÿå™¨ ==========
        const imageData = ctx.createImageData(256, 240);
        
        const keyMap = {
            'ArrowUp': jsnes.Controller.BUTTON_UP,
            'ArrowDown': jsnes.Controller.BUTTON_DOWN,
            'ArrowLeft': jsnes.Controller.BUTTON_LEFT,
            'ArrowRight': jsnes.Controller.BUTTON_RIGHT,
            'KeyX': jsnes.Controller.BUTTON_A, 'KeyK': jsnes.Controller.BUTTON_A,
            'KeyZ': jsnes.Controller.BUTTON_B, 'KeyJ': jsnes.Controller.BUTTON_B,
            'Enter': jsnes.Controller.BUTTON_START,
            'ShiftRight': jsnes.Controller.BUTTON_SELECT, 'ShiftLeft': jsnes.Controller.BUTTON_SELECT,
        };
        
        const touchMap = {
            'up': jsnes.Controller.BUTTON_UP, 'down': jsnes.Controller.BUTTON_DOWN,
            'left': jsnes.Controller.BUTTON_LEFT, 'right': jsnes.Controller.BUTTON_RIGHT,
            'a': jsnes.Controller.BUTTON_A, 'b': jsnes.Controller.BUTTON_B,
            'start': jsnes.Controller.BUTTON_START, 'select': jsnes.Controller.BUTTON_SELECT,
        };
        
        function showStatus(msg, isError = false) {
            status.style.background = isError ? 'rgba(255,0,0,0.15)' : 'rgba(0,255,0,0.15)';
            status.style.color = isError ? '#ff6b6b' : '#4ade80';
            status.textContent = msg;
        }
        
        function initNES() {
            nes = new jsnes.NES({
                onFrame: function(buffer) { frameBuffer = buffer; },
                onAudioSample: function(left, right) {
                    if (soundEnabled && audioCtx && audioCtx.state === 'running') {
                        audioSamples.push(left, right);
                        // é™åˆ¶ç¼“å†²åŒºå¤§å°
                        if (audioSamples.length > BUFFER_SIZE * 4) {
                            audioSamples.splice(0, BUFFER_SIZE * 2);
                        }
                    }
                }
            });
        }
        
        function loadROM(data) {
            try {
                romData = data; // ä¿å­˜ROMæ•°æ®ç”¨äºé‡ç½®
                initNES();
                nes.loadROM(data);
                showStatus('âœ… ç‚¹ã€ŒğŸ”‡ éŸ³æ•ˆã€å¼€å£°éŸ³ï¼ŒæŒ‰STARTå¼€å§‹');
                startGame();
            } catch (e) { showStatus('âŒ ' + e.message, true); }
        }
        
        function startGame() {
            if (animationId) cancelAnimationFrame(animationId);
            function frame() {
                if (!isPaused && nes) { nes.frame(); renderFrame(); }
                animationId = requestAnimationFrame(frame);
            }
            frame();
        }
        
        function renderFrame() {
            if (!frameBuffer) return;
            for (let i = 0; i < 256 * 240; i++) {
                imageData.data[i * 4] = frameBuffer[i] & 0xFF;
                imageData.data[i * 4 + 1] = (frameBuffer[i] >> 8) & 0xFF;
                imageData.data[i * 4 + 2] = (frameBuffer[i] >> 16) & 0xFF;
                imageData.data[i * 4 + 3] = 0xFF;
            }
            
            const targetCtx = isFullscreen ? ctxFs : ctx;
            const targetCanvas = isFullscreen ? canvasFs : canvas;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 256; tempCanvas.height = 240;
            tempCanvas.getContext('2d').putImageData(imageData, 0, 0);
            
            targetCtx.imageSmoothingEnabled = false;
            targetCtx.drawImage(tempCanvas, 0, 0, targetCanvas.width, targetCanvas.height);
        }
        
        function togglePause() { 
            isPaused = !isPaused; 
            pauseBtn.textContent = isPaused ? 'â–¶ï¸' : 'â¸ï¸';
            showStatus(isPaused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ ç»§ç»­'); 
        }
        
        let romData = null; // ä¿å­˜ROMæ•°æ®
        
        function resetGame() { 
            isPaused = false;
            pauseBtn.textContent = 'â¸ï¸';
            
            if (romData) {
                // é‡æ–°åŠ è½½ROM
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                initNES();
                nes.loadROM(romData);
                startGame();
                showStatus('ğŸ”„ æ¸¸æˆå·²é‡ç½®'); 
            }
        }
        
        function enterFullscreen() {
            isFullscreen = true;
            document.getElementById('normalMode').style.display = 'none';
            document.getElementById('fullscreenMode').classList.add('active');
            
            // å…ˆè¿›å…¥å…¨å±ï¼Œå†é”å®šæ¨ªå±
            const elem = document.documentElement;
            const goFullscreen = elem.requestFullscreen || elem.webkitRequestFullscreen;
            if (goFullscreen) {
                goFullscreen.call(elem).then(() => {
                    // é”å®šæ¨ªå±
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(() => {});
                    }
                    resizeFullscreenCanvas();
                }).catch(() => {
                    // å³ä½¿å…¨å±å¤±è´¥ä¹Ÿå°è¯•é”å®šæ¨ªå±
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(() => {});
                    }
                    resizeFullscreenCanvas();
                });
            } else {
                resizeFullscreenCanvas();
            }
        }
        
        function exitFullscreen() {
            isFullscreen = false;
            document.getElementById('fullscreenMode').classList.remove('active');
            document.getElementById('normalMode').style.display = 'flex';
            if (document.exitFullscreen) document.exitFullscreen().catch(() => {});
            if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
        }
        
        function resizeFullscreenCanvas() {
            let w, h;
            
            // æ£€æµ‹æ˜¯å¦ç«–å±ï¼ˆæ—‹è½¬æ¨¡å¼ï¼‰
            if (window.innerHeight > window.innerWidth) {
                // ç«–å±æ—¶ï¼Œå®½é«˜äº’æ¢ï¼ˆå› ä¸ºæˆ‘ä»¬æ—‹è½¬äº†90åº¦ï¼‰
                w = window.innerHeight;
                h = window.innerWidth;
            } else {
                w = window.innerWidth;
                h = window.innerHeight;
            }
            
            const ratio = 256 / 240;
            
            let ch = h;
            let cw = ch * ratio;
            
            if (cw > w) {
                cw = w;
                ch = cw / ratio;
            }
            
            canvasFs.width = 256;
            canvasFs.height = 240;
            canvasFs.style.width = Math.floor(cw) + 'px';
            canvasFs.style.height = Math.floor(ch) + 'px';
        }
        
        // ========== äº‹ä»¶ç»‘å®š ==========
        function bindBtn(btn, fn) {
            btn.ontouchend = (e) => { e.preventDefault(); fn(); };
            btn.onclick = fn;
        }
        bindBtn(pauseBtn, togglePause);
        bindBtn(resetBtn, resetGame);
        bindBtn(fullscreenBtn, enterFullscreen);
        bindBtn(exitFsBtn, exitFullscreen);
        bindBtn(soundBtn, toggleSound);
        
        window.addEventListener('resize', () => { if (isFullscreen) resizeFullscreenCanvas(); });
        window.addEventListener('orientationchange', () => { if (isFullscreen) setTimeout(resizeFullscreenCanvas, 100); });
        
        document.addEventListener('keydown', (e) => {
            if (nes && keyMap[e.code]) { nes.buttonDown(1, keyMap[e.code]); e.preventDefault(); }
        });
        
        document.addEventListener('keyup', (e) => {
            if (nes && keyMap[e.code]) { nes.buttonUp(1, keyMap[e.code]); e.preventDefault(); }
        });
        
        // ========== è™šæ‹Ÿæ‘‡æ†å¼åå­—é”® ==========
        let activeDpadKeys = new Set();
        let dpadTouchId = null;
        let dpadCenter = null;
        
        function pressKey(key) {
            if (!activeDpadKeys.has(key) && nes && touchMap[key]) {
                nes.buttonDown(1, touchMap[key]);
                activeDpadKeys.add(key);
            }
        }
        
        function releaseKey(key) {
            if (activeDpadKeys.has(key) && nes && touchMap[key]) {
                nes.buttonUp(1, touchMap[key]);
                activeDpadKeys.delete(key);
            }
        }
        
        function releaseAllDpad() {
            ['up', 'down', 'left', 'right'].forEach(k => releaseKey(k));
            document.querySelectorAll('.dpad-container .dpad-btn, .fs-dpad-inner .dpad-btn').forEach(b => b.classList.remove('pressed'));
            dpadTouchId = null;
            dpadCenter = null;
        }
        
        function updateDpadVisual(keys) {
            // æ›´æ–°ç«–å±å’Œæ¨ªå±çš„æ–¹å‘é”®æŒ‰é’®
            document.querySelectorAll('.dpad-container .dpad-btn, .fs-dpad-inner .dpad-btn').forEach(b => {
                const btnKey = b.dataset.key;
                const btnKeys = b.dataset.keys ? b.dataset.keys.split(',') : [];
                
                if (btnKey && keys.has(btnKey)) {
                    b.classList.add('pressed');
                } else if (btnKeys.length && btnKeys.every(k => keys.has(k))) {
                    b.classList.add('pressed');
                } else {
                    b.classList.remove('pressed');
                }
            });
        }
        
        // æ£€æµ‹æ˜¯å¦ç«–å±æ—‹è½¬æ¨¡å¼
        function isPortraitRotated() {
            return window.innerHeight > window.innerWidth && isFullscreen;
        }
        
        function calcDpadDirection(touch, center) {
            let dx = touch.clientX - center.x;
            let dy = touch.clientY - center.y;
            
            // ç«–å±æ—‹è½¬æ¨¡å¼ä¸‹ï¼Œåæ ‡ä¹Ÿè¦æ—‹è½¬90åº¦
            if (isPortraitRotated()) {
                const temp = dx;
                dx = dy;
                dy = -temp;
            }
            
            const deadzone = 15; // æ­»åŒºåŠå¾„
            
            const newKeys = new Set();
            
            if (Math.abs(dx) > deadzone || Math.abs(dy) > deadzone) {
                // 8æ–¹å‘æ£€æµ‹
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                // ä¸Š: -112.5 åˆ° -67.5
                // å³ä¸Š: -67.5 åˆ° -22.5
                // å³: -22.5 åˆ° 22.5
                // å³ä¸‹: 22.5 åˆ° 67.5
                // ä¸‹: 67.5 åˆ° 112.5
                // å·¦ä¸‹: 112.5 åˆ° 157.5
                // å·¦: 157.5 åˆ° 180 æˆ– -180 åˆ° -157.5
                // å·¦ä¸Š: -157.5 åˆ° -112.5
                
                if (angle >= -112.5 && angle < -67.5) {
                    newKeys.add('up');
                } else if (angle >= -67.5 && angle < -22.5) {
                    newKeys.add('up'); newKeys.add('right');
                } else if (angle >= -22.5 && angle < 22.5) {
                    newKeys.add('right');
                } else if (angle >= 22.5 && angle < 67.5) {
                    newKeys.add('down'); newKeys.add('right');
                } else if (angle >= 67.5 && angle < 112.5) {
                    newKeys.add('down');
                } else if (angle >= 112.5 && angle < 157.5) {
                    newKeys.add('down'); newKeys.add('left');
                } else if (angle >= 157.5 || angle < -157.5) {
                    newKeys.add('left');
                } else if (angle >= -157.5 && angle < -112.5) {
                    newKeys.add('up'); newKeys.add('left');
                }
            }
            
            return newKeys;
        }
        
        function handleDpadStart(e) {
            e.preventDefault();
            unlockAudio();
            
            const touch = e.changedTouches[0];
            if (!touch) return;
            
            // è·å–å®¹å™¨çš„ä¸­å¿ƒç‚¹
            const container = e.currentTarget;
            const rect = container.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            dpadTouchId = touch.identifier;
            dpadCenter = { x: centerX, y: centerY };
            
            // ç«‹å³è®¡ç®—æ–¹å‘
            const newKeys = calcDpadDirection(touch, dpadCenter);
            
            // æ›´æ–°æŒ‰é”®çŠ¶æ€
            ['up', 'down', 'left', 'right'].forEach(k => {
                if (newKeys.has(k)) pressKey(k);
                else releaseKey(k);
            });
            
            updateDpadVisual(newKeys);
        }
        
        function handleDpadMove(e) {
            e.preventDefault();
            if (dpadTouchId === null || !dpadCenter) return;
            
            let touch = null;
            for (let i = 0; i < e.touches.length; i++) {
                if (e.touches[i].identifier === dpadTouchId) {
                    touch = e.touches[i];
                    break;
                }
            }
            
            if (!touch) return;
            
            const newKeys = calcDpadDirection(touch, dpadCenter);
            
            // æ›´æ–°æŒ‰é”®çŠ¶æ€
            ['up', 'down', 'left', 'right'].forEach(k => {
                if (newKeys.has(k)) pressKey(k);
                else releaseKey(k);
            });
            
            updateDpadVisual(newKeys);
        }
        
        function handleDpadEnd(e) {
            e.preventDefault();
            
            let found = false;
            for (let i = 0; i < e.touches.length; i++) {
                if (e.touches[i].identifier === dpadTouchId) {
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                releaseAllDpad();
            }
        }
        
        // è·å– fs-dpad-inner çš„ä¸­å¿ƒç‚¹ï¼ˆç”¨äºæ¨ªå±æ–¹å‘è®¡ç®—ï¼‰
        function getFsDpadCenter() {
            const inner = document.querySelector('.fs-dpad-inner');
            if (!inner) return null;
            const rect = inner.getBoundingClientRect();
            return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
        }
        
        function handleFsDpadStart(e) {
            e.preventDefault();
            unlockAudio();
            
            const touch = e.changedTouches[0];
            if (!touch) return;
            
            // ä½¿ç”¨ fs-dpad-inner çš„ä¸­å¿ƒä½œä¸ºå‚è€ƒç‚¹
            const center = getFsDpadCenter();
            if (!center) return;
            
            dpadTouchId = touch.identifier;
            dpadCenter = center;
            
            // ç«‹å³è®¡ç®—æ–¹å‘
            const newKeys = calcDpadDirection(touch, dpadCenter);
            
            // æ›´æ–°æŒ‰é”®çŠ¶æ€
            ['up', 'down', 'left', 'right'].forEach(k => {
                if (newKeys.has(k)) pressKey(k);
                else releaseKey(k);
            });
            
            updateDpadVisual(newKeys);
        }
        
        // ä¸ºç«–å±åå­—é”®å®¹å™¨æ·»åŠ è™šæ‹Ÿæ‘‡æ†æ”¯æŒ
        document.querySelectorAll('.dpad-container').forEach(container => {
            container.addEventListener('touchstart', handleDpadStart, { passive: false });
            container.addEventListener('touchmove', handleDpadMove, { passive: false });
            container.addEventListener('touchend', handleDpadEnd, { passive: false });
            container.addEventListener('touchcancel', handleDpadEnd, { passive: false });
        });
        
        // ä¸ºæ¨ªå±æ•´ä¸ªå·¦åŠå±åŒºåŸŸæ·»åŠ è™šæ‹Ÿæ‘‡æ†æ”¯æŒ
        const fsDpad = document.getElementById('fsDpad');
        if (fsDpad) {
            fsDpad.addEventListener('touchstart', handleFsDpadStart, { passive: false });
            fsDpad.addEventListener('touchmove', handleDpadMove, { passive: false });
            fsDpad.addEventListener('touchend', handleDpadEnd, { passive: false });
            fsDpad.addEventListener('touchcancel', handleDpadEnd, { passive: false });
        }
        
        // ========== A/B/C/START/SELECT æŒ‰é’® ==========
        let turboInterval = null;
        
        function setupActionButton(btn) {
            const key = btn.dataset.key;
            if (!key || ['up','down','left','right'].includes(key)) return; // è·³è¿‡æ–¹å‘é”®
            
            // è¿å‘æ¨¡å¼ (Cé”® = turbo-b)
            if (key === 'turbo-b') {
                function startTurbo(e) {
                    e.preventDefault(); e.stopPropagation();
                    unlockAudio();
                    btn.classList.add('pressed');
                    
                    // ç«‹å³æŒ‰ä¸€æ¬¡
                    if (nes) nes.buttonDown(1, touchMap['b']);
                    
                    // å¼€å§‹è¿å‘ (æ¯ç§’çº¦15æ¬¡)
                    if (turboInterval) clearInterval(turboInterval);
                    let isDown = true;
                    turboInterval = setInterval(() => {
                        if (nes) {
                            if (isDown) nes.buttonUp(1, touchMap['b']);
                            else nes.buttonDown(1, touchMap['b']);
                            isDown = !isDown;
                        }
                    }, 33); // ~30æ¬¡/ç§’åˆ‡æ¢ = 15æ¬¡å®Œæ•´æŒ‰æ”¾
                }
                
                function stopTurbo(e) {
                    e.preventDefault(); e.stopPropagation();
                    btn.classList.remove('pressed');
                    if (turboInterval) {
                        clearInterval(turboInterval);
                        turboInterval = null;
                    }
                    if (nes) nes.buttonUp(1, touchMap['b']);
                }
                
                btn.addEventListener('touchstart', startTurbo, { passive: false });
                btn.addEventListener('touchend', stopTurbo, { passive: false });
                btn.addEventListener('touchcancel', stopTurbo, { passive: false });
                btn.addEventListener('mousedown', startTurbo);
                btn.addEventListener('mouseup', stopTurbo);
                btn.addEventListener('mouseleave', stopTurbo);
                return;
            }
            
            function press(e) {
                e.preventDefault(); e.stopPropagation();
                unlockAudio();
                btn.classList.add('pressed');
                if (nes && touchMap[key] !== undefined) nes.buttonDown(1, touchMap[key]);
            }
            
            function release(e) {
                e.preventDefault(); e.stopPropagation();
                btn.classList.remove('pressed');
                if (nes && touchMap[key] !== undefined) nes.buttonUp(1, touchMap[key]);
            }
            
            btn.addEventListener('touchstart', press, { passive: false });
            btn.addEventListener('touchend', release, { passive: false });
            btn.addEventListener('touchcancel', release, { passive: false });
            btn.addEventListener('mousedown', press);
            btn.addEventListener('mouseup', release);
            btn.addEventListener('mouseleave', release);
        }
        
        document.querySelectorAll('.action-btn, .small-btn').forEach(setupActionButton);
        
        // ========== åŠ è½½ ROM ==========
        fetch('Contra%20(USA).nes')
            .then(r => { if (!r.ok) throw new Error('ROMæœªæ‰¾åˆ°'); return r.arrayBuffer(); })
            .then(buf => { const d = new Uint8Array(buf); let s = ''; for (let i = 0; i < d.length; i++) s += String.fromCharCode(d[i]); loadROM(s); })
            .catch(e => showStatus('âŒ ' + e.message, true));
        
        document.body.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
    </script>
</body>
</html>
